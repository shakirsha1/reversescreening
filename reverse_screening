name: PharmacoNet Reverse Screening

on:
  push:
    branches: [ main, master ]
    paths:
      - 'input/pdb_database.csv'
      - 'input/query_molecules.csv'
      - '.github/workflows/reverse_screening.yml'
  
  workflow_dispatch:
    inputs:
      num_conformers:
        description: 'Number of conformers to generate'
        required: false
        default: '50'
      min_score:
        description: 'Minimum score threshold'
        required: false
        default: '5.0'
      top_n:
        description: 'Top N results per query'
        required: false
        default: '50'

jobs:
  reverse-screening:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true
    
    - name: Validate input files
      run: |
        echo "Checking input files..."
        
        if [ ! -f input/pdb_database.csv ]; then
          echo "ERROR: input/pdb_database.csv not found!"
          exit 1
        fi
        
        if [ ! -f input/query_molecules.csv ]; then
          echo "ERROR: input/query_molecules.csv not found!"
          exit 1
        fi
        
        # Check if CSVs have content
        PDB_LINES=$(wc -l < input/pdb_database.csv)
        QUERY_LINES=$(wc -l < input/query_molecules.csv)
        
        if [ "$PDB_LINES" -lt 2 ]; then
          echo "ERROR: pdb_database.csv is empty or has only header!"
          exit 1
        fi
        
        if [ "$QUERY_LINES" -lt 2 ]; then
          echo "ERROR: query_molecules.csv is empty or has only header!"
          exit 1
        fi
        
        echo "✓ Input files validated"
        echo "  PDB entries: $((PDB_LINES - 1))"
        echo "  Query molecules: $((QUERY_LINES - 1))"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libxrender1 \
          libxext6 \
          libsm6 \
          libgl1
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
        pip install rdkit pandas matplotlib seaborn scikit-learn biopython
        
        # Install PharmacoNet if setup.py exists
        if [ -f setup.py ]; then
          pip install -e .
        else
          echo "WARNING: setup.py not found, skipping pmnet installation"
        fi
    
    - name: Verify installation
      run: |
        python -c "import torch; print(f'PyTorch: {torch.__version__}')"
        python -c "import rdkit; print(f'RDKit: {rdkit.__version__}')"
        python -c "import pandas; print(f'Pandas: {pandas.__version__}')"
        
        # Check if pmnet is available
        if python -c "import pmnet" 2>/dev/null; then
          python -c "import pmnet; print(f'PharmacoNet: {pmnet.__version__}')"
        else
          echo "WARNING: pmnet module not found (this is okay if using standalone scripts)"
        fi
    
    - name: Count input entries
      id: count_inputs
      run: |
        PDB_COUNT=$(tail -n +2 input/pdb_database.csv | wc -l)
        QUERY_COUNT=$(tail -n +2 input/query_molecules.csv | wc -l)
        echo "pdb_count=$PDB_COUNT" >> $GITHUB_OUTPUT
        echo "query_count=$QUERY_COUNT" >> $GITHUB_OUTPUT
        echo "Found $PDB_COUNT proteins and $QUERY_COUNT query molecules"
    
    - name: Create output directories
      run: |
        mkdir -p output
        mkdir -p results
        mkdir -p results/analysis
    
    - name: Build protein pharmacophore database
      id: build_database
      continue-on-error: true
      run: |
        echo "Building pharmacophore models for ${{ steps.count_inputs.outputs.pdb_count }} proteins..."
        echo "This may take several hours for large databases."
        
        if [ -f batch_modeling.py ]; then
          python batch_modeling.py \
            --input_csv input/pdb_database.csv \
            --output_dir output \
            2>&1 | tee build_database.log
        else
          echo "ERROR: batch_modeling.py not found!"
          echo "Please add batch_modeling.py to your repository"
          exit 1
        fi
        
        # Count generated models
        MODEL_COUNT=$(find output -name "*.pm" 2>/dev/null | wc -l)
        echo "model_count=$MODEL_COUNT" >> $GITHUB_OUTPUT
        echo "Generated $MODEL_COUNT pharmacophore models"
    
    - name: Validate database
      run: |
        MODEL_COUNT=${{ steps.build_database.outputs.model_count }}
        
        if [ "$MODEL_COUNT" = "" ] || [ "$MODEL_COUNT" -eq 0 ]; then
          echo "ERROR: No pharmacophore models were generated!"
          echo ""
          echo "Possible causes:"
          echo "1. batch_modeling.py failed to run"
          echo "2. Invalid PDB codes in pdb_database.csv"
          echo "3. Network issues downloading PDB files"
          echo "4. Python environment issues"
          echo ""
          echo "Check build_database.log for details"
          
          if [ -f build_database.log ]; then
            echo ""
            echo "Last 50 lines of build_database.log:"
            tail -50 build_database.log
          fi
          
          exit 1
        fi
        
        echo "✓ Database validation passed: $MODEL_COUNT models"
    
    - name: Run reverse screening
      continue-on-error: true
      run: |
        NUM_CONFORMERS=${{ github.event.inputs.num_conformers || '50' }}
        MIN_SCORE=${{ github.event.inputs.min_score || '5.0' }}
        TOP_N=${{ github.event.inputs.top_n || '50' }}
        
        echo "Running reverse screening with:"
        echo "  Conformers: $NUM_CONFORMERS"
        echo "  Min score: $MIN_SCORE"
        echo "  Top N: $TOP_N"
        echo "  CPUs: $(nproc)"
        
        if [ -f reverse_screening.py ]; then
          python reverse_screening.py \
            --query_csv input/query_molecules.csv \
            --model_database_dir output \
            --out results/screening_results.csv \
            --num_conformers $NUM_CONFORMERS \
            --min_score $MIN_SCORE \
            --top_n $TOP_N \
            --cpus $(nproc) \
            2>&1 | tee screening.log
        else
          echo "ERROR: reverse_screening.py not found!"
          exit 1
        fi
    
    - name: Analyze results
      continue-on-error: true
      run: |
        if [ ! -f results/screening_results.csv ]; then
          echo "ERROR: Screening results not found!"
          exit 1
        fi
        
        RESULT_COUNT=$(tail -n +2 results/screening_results.csv 2>/dev/null | wc -l)
        echo "Found $RESULT_COUNT screening results"
        
        if [ "$RESULT_COUNT" -eq 0 ]; then
          echo "WARNING: No screening results (all scores below threshold)"
          mkdir -p results/analysis
          echo "No results found - all scores below threshold" > results/analysis/analysis_report.txt
        else
          echo "Analyzing results..."
          if [ -f scripts/analyze_results.py ]; then
            python scripts/analyze_results.py results/screening_results.csv \
              --output_dir results/analysis \
              2>&1 | tee analysis.log
          else
            echo "WARNING: scripts/analyze_results.py not found, skipping analysis"
          fi
        fi
    
    - name: Generate summary report
      run: |
        cat > results/SUMMARY.md << EOF
        # PharmacoNet Reverse Screening Results
        
        ## Run Information
        - **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Workflow:** ${{ github.workflow }}
        - **Run ID:** ${{ github.run_id }}
        - **Commit:** ${{ github.sha }}
        
        ## Input Summary
        - **Proteins in database:** ${{ steps.count_inputs.outputs.pdb_count }}
        - **Pharmacophore models generated:** ${{ steps.build_database.outputs.model_count }}
        - **Query molecules:** ${{ steps.count_inputs.outputs.query_count }}
        
        ## Screening Parameters
        - **Conformers per molecule:** ${{ github.event.inputs.num_conformers || '50' }}
        - **Minimum score threshold:** ${{ github.event.inputs.min_score || '5.0' }}
        - **Top N per query:** ${{ github.event.inputs.top_n || '50' }}
        - **CPUs used:** $(nproc)
        
        ## Output Files
        EOF
        
        if [ -f results/screening_results.csv ]; then
          echo "- \`screening_results.csv\` - Raw screening results" >> results/SUMMARY.md
        fi
        
        if [ -f results/analysis/score_distribution.png ]; then
          echo "- \`analysis/score_distribution.png\` - Score distribution plot" >> results/SUMMARY.md
        fi
        
        if [ -f results/screening_results.csv ]; then
          echo "" >> results/SUMMARY.md
          echo "### Top 5 Matches (Highest Scores)" >> results/SUMMARY.md
          echo '```' >> results/SUMMARY.md
          head -6 results/screening_results.csv | column -t -s',' >> results/SUMMARY.md || head -6 results/screening_results.csv >> results/SUMMARY.md
          echo '```' >> results/SUMMARY.md
        fi
        
        cat results/SUMMARY.md
    
    - name: Upload screening results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: screening-results-${{ github.run_id }}
        path: |
          results/
        retention-days: 90
    
    - name: Upload pharmacophore models
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: pharmacophore-models-${{ github.run_id }}
        path: |
          output/**/*.pm
        retention-days: 30
    
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: logs-${{ github.run_id }}
        path: |
          *.log
        retention-days: 30
